---
- name: zsh > installing dependencies
  become: true
  ansible.builtin.package:
    name: '{{ dotfiles_zsh_pkg_items }}'
    state: present

- name: zsh > installing starship using cargo
  ansible.builtin.command: 'cargo install starship --locked'
  when: ansible_os_family == 'Debian'

- name: zsh > setting default shell for {{ username }}
  become: true
  ansible.builtin.user:
    name: '{{ username }}'
    shell: '{{ dotfiles_zsh_path }}'

- name: zsh > install dotfiles with stow
  ansible.builtin.command: 'stow -d {{ dotfiles_stow_dir }} -Rt ~/ {{ dotfiles_zsh_stow_dir }}'
  when: dotfiles_stow_dir is defined and dotfiles_zsh_stow_dir is defined

# installing extensions if any
- include_tasks: get-tar.yml
  loop: '{{ dotfiles_zsh_theme_items }}'
  loop_control:
    loop_var: tar_item
  vars:
    to_dest: '{{ dotfiles_zsh_theme_dir }}'
  when: dotfiles_zsh_theme_dir is defined and dotfiles_zsh_theme_items | length > 0

- name: zsh > make symbolink links
  ansible.builtin.file:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    state: link
  with_items: '{{ dotfiles_zsh_link_items }}'
  when: dotfiles_zsh_link_items | length > 0

- name: zsh > check if collection has changed for reaver
  ansible.builtin.lineinfile:
    path: '{{ dotfiles_zsh_reaver_cache_dir }}/metadata.yml'
    line: 'changed: true'
    state: present
  check_mode: yes
  register: presence
  when: dotfiles_zsh_reaver_cache_dir is defined

- name: zsh > create reaver path's
  ansible.builtin.file:
    path: '{{ item.dest }}'
    state: directory
  with_items: '{{ dotfiles_zsh_reaver_install }}'
  when: dotfiles_zsh_reaver_install | length > 0

- name: zsh > installing archives
  ansible.builtin.unarchive:
    src: '{{ dotfiles_zsh_reaver_cache_dir }}/{{ item.src }}'
    dest: '{{ item.dest }}'
    extra_opts: [--strip-components=1] # remove first directory (only for tar)
  with_items: '{{ dotfiles_zsh_reaver_install }}'
  when: dotfiles_zsh_reaver_cache_dir is defined and dotfiles_zsh_reaver_install | length > 0 and presence is not changed

- name: zsh > reaver finish
  ansible.builtin.lineinfile:
    path: '{{ dotfiles_zsh_reaver_cache_dir }}/metadata.yml'
    regexp: '^changed'
    line: 'changed: false'
  when: dotfiles_zsh_reaver_cache_dir is defined
